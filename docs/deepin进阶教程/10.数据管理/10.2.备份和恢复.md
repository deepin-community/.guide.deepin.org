# 10.2. 备份和恢复

我们都熟知计算机有时会出问题，或者由于人为的错误导致系统和数据损坏。备份和恢复操作是成功的系统管理中非常重要的一部分。可能有一天你的电脑就会出问题

::: tip
保持你的备份系统简洁并且经常备份你的系统，有备份数据比你采用的备份方法的技术先进要重要的多
:::

## 10.2.1. 备份和恢复策略

有3个关键的因素决定实际的备份和恢复策略。

1. 知道要备份和恢复什么。
   - 你自己创建的数据文件：在 "~/" 下的数据
   - 你使用的应用程序创建的数据文件：在 "/var/" 下的数据（除了 "/var/cache/"，"/var/run/" 和 "/var/tmp/")
   - 系统配置文件：在 "/etc/” 下的数据
   - 本地程序：在 "/usr/local/" 或 "/opt/" 下的数据
   - 系统安装信息：关键步骤 (分区,...) 的纯文本备忘录
   - 验证数据结果：通过实验性的恢复操作来预先验证
     - 用户进程的 Cron 工作，文件在 "/var/spool/cron/crontabs" 目录，并且重启 cron(8)。参见第 9.4.14 节 “定时任务安排”来获得关于 cron(8) 和 crontab(1) 的信息。
     - 用户进程的 Systemd 计时器工作：文件在 "~/.config/systemd/user" 目录。参见 systemd.timer(5) 和 systemd.service(5)。
     - 用户进程的自动启动工作：文件在 "~/.config/autostart" 目录。参见 Desktop Application Autostart Specification。
2. 知道怎样去备份和恢复。
   - 安全的数据存储：保护其免于覆盖和系统故障
   - 经常备份：有计划的备份
   - 冗余备份：数据镜像
   - 傻瓜式操作：单个简单命令备份
3. 评估涉及的风险和成本。
   - 数据丢失的风险
     - 数据至少是应该在不同的磁盘分区上，最好是在不同的磁盘和机器上，来承受文件系统发生的损坏。重要数据最好存储在一个只读文件系统上。[4]
   - 数据非法访问的风险
     - 敏感的身份数据，比如 "/etc/ssh/ssh_host_*_key", "~/.gnupg/*", "~/.ssh/*", "~/.local/share/keyrings/*", "/etc/passwd", "/etc/shadow", "popularity-contest.conf", "/etc/ppp/pap-secrets", and "/etc/exim4/passwd.client" 应当使用加密备份。[5] (参见 第 9.9 节 “数据加密提示”。)
     - 即使在信任的系统上，也不能够硬编码系统登录密码或者加密密码到任何脚本里面。(参见 第 10.3.6 节 “密码密钥环”。)
4. 数据丢失的方式及其可能性
   - 硬件（特别是硬盘）将会损坏
   - 文件系统可能会损坏，里面的数据可能被丢失
   - 对违规安全访问而言，远程存储系统不能够被信任
   - 弱的密码保护能够被轻松的破解
   - 文件权限系统可以被破解

5. 备份所需的资源：人力，硬件，软件，…
   - 使用 cron 任务或者 systemd 计时器任务来自动化调度备份工作

::: warning 注意
除非你知道自己做的是什么，否则不要备份 /proc, /sys, /tmp, 和 /run 目录下的伪文件系统（参见 第 1.2.12 节 “procfs 和 sysfs” 和 第 1.2.13 节 “tmpfs”)。它们是庞大且无用的数据。
:::

::: warning 注意
当备份数据的时候，你可能希望停止一些应用程序的守护进程例如 MTA（参见第 6.2.4 节 “邮件传输代理 (MTA)”）。
:::

## 10.2.2. 实用备份套件

这里推荐使用deepin团队研发的备份还原工具
[deepin-clone](https://github.com/linuxdeepin/deepin-clone)

进入”控制中心-系统信息-备份/还原-备份“，点击“...”打开备份需要保存的路径
备份失败将失败原因发送给开发者，提示用户“备份失败，失败原因：xxx”并删除失败的备份文件。备份失败将失败原因发送给开发者，提示用户“备份失败，失败原因：xxx”
备份成功后，提示用户“备份成功”

备份功能有二种模式：

- 全盘备份：备份全磁盘系统文件和用户产生的文件。
- 系统备份：备份根分区、启动分区

全盘备份无法备份在自己的磁盘里，只能备份在其它存储介质，系统备份则备份在默认位置，如果磁盘空间不足请提示，允许用户可以手动指定可以存放的磁盘位置。

点击“备份”，弹出密码输入框，输入密码正确后开始计算备份的容量是否满足存放磁盘的空间的容量，如果不满足则提示“磁盘空间不足”。

备份还原开启后，配置文件写入完毕后，立即重启进入 live 系统进行备份

备份时需记录磁盘唯一标识，用于还原时磁盘更换提醒

备份文件成功后需写入此次备份对应信息，写入失败需提示“写入备份信息失败”

准备备份中，若找不到当前系统所在的磁盘需提示“找不到当前操作系统所在磁盘”

开始备份时，遇到异常终止启动备份需提示“创建任务失败”

点击备份后，需修改系统一系列配置，显示“正在配置中...”提示

备份的存储介质文件系统不支持需提示“该存储介质的文件系统不支持备份”。目前支持的格式有 "ext4", "ntfs","xfs", "btrfs", "reiserfs", "exfat"
